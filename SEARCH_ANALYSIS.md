# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º –ø–æ–∏—Å–∫–∞

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ò–Ω–¥–µ–∫—Å –Ω–µ –ø—É—Å—Ç–æ–π**: 639 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ ChromaDB
2. **Reranking –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω**: –ú–æ–¥–µ–ª—å `DiTy/cross-encoder-russian-msmarco` –∑–∞–≥—Ä—É–∂–µ–Ω–∞
3. **Hybrid Search —Ä–∞–±–æ—Ç–∞–µ—Ç**: Vector + BM25 –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è
4. **Query Expansion —Ä–∞–±–æ—Ç–∞–µ—Ç**: –°–∏–Ω–æ–Ω–∏–º—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã

### 1. Scores –ø–æ—Å–ª–µ reranking —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–µ

**–§–∞–∫—Ç:**
- Top score: `0.001` –∏ `0.018` (–æ—á–µ–Ω—å –Ω–∏–∑–∫–∏–µ!)
- –ü–æ—Ä–æ–≥–∏: `RERANK_THRESHOLD_TECHNICAL=0.01`, `RERANK_THRESHOLD_GENERAL=0.005`
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞—é—Ç—Å—è, —Ç.–∫. scores < –ø–æ—Ä–æ–≥–æ–≤

**–ü—Ä–∏—á–∏–Ω–∞:**
–ú–æ–¥–µ–ª—å `DiTy/cross-encoder-russian-msmarco` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—á–µ–Ω—å –Ω–∏–∑–∫–∏–µ scores (0.001-0.295 –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏), —á—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —ç—Ç–æ–π –º–æ–¥–µ–ª–∏. –ù–æ –ø–æ—Ä–æ–≥–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–æ.

**–†–µ—à–µ–Ω–∏–µ:**
–°–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥–∏ –≤ `.env`:
```bash
# –í—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–º–æ–¥–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∏–∑–∫–∏–µ scores)
RERANK_THRESHOLD_TECHNICAL=0.001
RERANK_THRESHOLD_GENERAL=0.0005
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –º—è–≥–∫—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é - –Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å–µ –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞, –∞ –æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–æ–ø-N.

---

### 2. Query Rewriting –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (403 –æ—à–∏–±–∫–∞)

**–§–∞–∫—Ç:**
```
‚ö†Ô∏è OpenRouter rewriting failed: Error code: 403 - 
{'error': {'message': 'Provider returned error', 'code': 403, 
'metadata': {'raw': '{"error":{"code":"unsupported_country_region_territory",
"message":"Country, region, or territory not supported"}}'}}}
```

**–ü—Ä–∏—á–∏–Ω–∞:**
OpenRouter –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏–∑ –≤–∞—à–µ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –†–æ—Å—Å–∏—è/–ë–µ–ª–∞—Ä—É—Å—å).

**–†–µ—à–µ–Ω–∏–µ:**
1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Ollama –∫–∞–∫ fallback** (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
   ```bash
   QUERY_REWRITING_SOURCE=ollama
   ```
   –ò–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ fallback.

2. **–ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–∫—Å–∏** –¥–ª—è OpenRouter (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –∏–º–µ–Ω–Ω–æ OpenRouter).

3. **–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å** –¥–ª—è Query Rewriting.

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- OpenRouter –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –∑–∞–ø—Ä–æ—Å ‚Üí 403 –æ—à–∏–±–∫–∞
- Fallback –Ω–∞ Ollama –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (–≤–æ–∑–º–æ–∂–Ω–æ, Ollama –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
- Query Rewriting –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è ‚Üí –æ–ø–µ—á–∞—Ç–∫–∏ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

---

### 3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π space –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö

**–§–∞–∫—Ç:**
- –ü–æ–∏—Å–∫ –∏–¥–µ—Ç –≤ space `"Surveys"`
- –ù–æ –Ω—É–∂–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ space `"RAUII"`

**–†–µ—à–µ–Ω–∏–µ:**
–£–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π space –≤ –∑–∞–ø—Ä–æ—Å–µ:
```python
# –í Open WebUI –∏–ª–∏ –≤ —Ç–µ—Å—Ç–∞—Ö
space="RAUII"  # –≤–º–µ—Å—Ç–æ "Surveys"
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –¢–µ—Å—Ç 1: –£—á–µ—Ç –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
- **–ó–∞–ø—Ä–æ—Å:** "–ü—Ä–æ–≤–æ–∂—É –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –±–ª–æ–∫—É –°–∫–ª–∞–¥, –∞ —Ç–æ—á–Ω–µ–µ –£—á–µ—Ç –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã. –ü–æ–¥–≥–æ—Ç–æ–≤—å —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤."
- **–û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞:** `18153754`
- **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–∏–Ω–∏–º—É–º 30+ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ —Ä–∞–∑–¥–µ–ª–æ–≤:
  1. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
  2. –£—á–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤
  3. –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  4. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
  5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

### –¢–µ—Å—Ç 2: –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ (—Å –æ–ø–µ—á–∞—Ç–∫–∞–º–∏)
- **–ó–∞–ø—Ä–æ—Å:** "–ö–∫–æ–π —Ç—Ö–Ω–æ–ª–æ–≥–∏–µ—Å–∫–∏–π —Å—Ç–µ–∫ –∏—Å–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç —Ä–∞—É –∏–∏."
- **–û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞:** `18153591`
- **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 
  - Query Rewriting –¥–æ–ª–∂–µ–Ω –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ–ø–µ—á–∞—Ç–∫–∏
  - –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–µ–∫–µ (Ollama, OpenRouter, LiteLLM, MCP, –∏ —Ç.–¥.)

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –®–∞–≥ 1: –°–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥–∏ reranking

–í `.env`:
```bash
# –í—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–º–æ–¥–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∏–∑–∫–∏–µ scores)
RERANK_THRESHOLD_TECHNICAL=0.001
RERANK_THRESHOLD_GENERAL=0.0005
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
```bash
docker-compose restart confluence-rag
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Query Rewriting

**–í–∞—Ä–∏–∞–Ω—Ç A: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Ollama (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)**
```bash
QUERY_REWRITING_SOURCE=ollama
OLLAMA_URL=http://ollama:11434
OLLAMA_MODEL=llama3.2  # –∏–ª–∏ –¥—Ä—É–≥–∞—è –º–æ–¥–µ–ª—å
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –û—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ fallback**
```bash
QUERY_REWRITING_SOURCE=
# –°–∏—Å—Ç–µ–º–∞ –ø–æ–ø—Ä–æ–±—É–µ—Ç Ollama, –∑–∞—Ç–µ–º OpenRouter, –∑–∞—Ç–µ–º –æ—Ç–∫–ª—é—á–∏—Ç—Å—è
```

### –®–∞–≥ 3: –£–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π space

–í –∑–∞–ø—Ä–æ—Å–∞—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `space="RAUII"` –≤–º–µ—Å—Ç–æ `space="Surveys"`.

### –®–∞–≥ 4: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
```bash
python analyze_search_results.py
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Open WebUI:
1. –ó–∞–ø—Ä–æ—Å 1: `space="RAUII"`, query="–ü—Ä–æ–≤–æ–∂—É –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –±–ª–æ–∫—É –°–∫–ª–∞–¥, –∞ —Ç–æ—á–Ω–µ–µ –£—á–µ—Ç –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã. –ü–æ–¥–≥–æ—Ç–æ–≤—å —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤."
2. –ó–∞–ø—Ä–æ—Å 2: `space="RAUII"`, query="–ö–∫–æ–π —Ç—Ö–Ω–æ–ª–æ–≥–∏–µ—Å–∫–∏–π —Å—Ç–µ–∫ –∏—Å–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç —Ä–∞—É –∏–∏."

---

## üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤

### `analyze_search_results.py`
–°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏:
```bash
python analyze_search_results.py
```

### `EXPECTED_RESULTS.md`
–î–æ–∫—É–º–µ–Ω—Ç —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏ –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚ùå Scores —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–µ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞—é—Ç—Å—è
- ‚ùå Query Rewriting –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí –æ–ø–µ—á–∞—Ç–∫–∏ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
- ‚ö†Ô∏è –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π space ‚Üí –ø–æ–∏—Å–∫ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- ‚úÖ Scores –ø—Ä–æ–π–¥—É—Ç –ø–æ—Ä–æ–≥–∏ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è
- ‚úÖ Query Rewriting –∏—Å–ø—Ä–∞–≤–∏—Ç –æ–ø–µ—á–∞—Ç–∫–∏ ‚Üí –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π space ‚Üí –Ω–∞–π–¥—É—Ç—Å—è –Ω—É–∂–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

**–û–∂–∏–¥–∞–µ–º–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 80-90/100

