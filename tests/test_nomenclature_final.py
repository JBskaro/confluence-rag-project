#!/usr/bin/env python3
"""
–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã "–£—á–µ—Ç –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã"
"""
import sys
import re

try:
    from server import collection
    import server
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    if hasattr(server.confluence_semantic_search, 'fn'):
        confluence_semantic_search = server.confluence_semantic_search.fn
    else:
        confluence_semantic_search = server.confluence_semantic_search.__wrapped__
    
    query = "–£—á–µ—Ç –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –Ω–∞ —Å–∫–ª–∞–¥–µ —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤"
    
    print("=" * 80)
    print("–§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
    print("=" * 80)
    print(f"\nüìù –ó–∞–ø—Ä–æ—Å: {query}")
    print(f"üéØ –û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: pageId=18153754")
    print("\n" + "=" * 80)
    
    result = confluence_semantic_search(query, limit=10, space="Surveys")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ pageId=18153754
    if "18153754" not in result:
        print("‚ùå –û–®–ò–ë–ö–ê: –°—Ç—Ä–∞–Ω–∏—Ü–∞ pageId=18153754 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        sys.exit(1)
    
    print("‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ pageId=18153754 –Ω–∞–π–¥–µ–Ω–∞!")
    print("\n" + "=" * 80)
    print("–ü–†–û–í–ï–†–ö–ê –ù–ê–õ–ò–ß–ò–Ø –í–°–ï–• –†–ê–ó–î–ï–õ–û–í:")
    print("=" * 80)
    
    # –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–∞–∑–¥–µ–ª—ã
    expected_sections = [
        "1. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã",
        "2. –£—á–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤",
        "3. –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã",
        "4. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤",
        "5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã"
    ]
    
    # –ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
    expected_questions = {
        "–†–∞–∑–¥–µ–ª 1": [
            "–ö–∞–∫–∏–µ –≥—Ä—É–ø–ø—ã, –≤–∏–¥—ã –∏ —Ç–∏–ø—ã –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è",
            "–ö–∞–∫ —á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è",
            "–ï—Å—Ç—å –ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–∏",
            "–ö–∞–∫–æ–≤ –ø–µ—Ä–µ—á–µ–Ω—å —Ç–æ–≤–∞—Ä–Ω—ã—Ö –≥—Ä—É–ø–ø",
            "–ï—Å—Ç—å –ª–∏ –Ω–µ–≥–∞–±–∞—Ä–∏—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã"
        ],
        "–†–∞–∑–¥–µ–ª 2": [
            "–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ —Å–µ—Ä–∏–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏",
            "–ö–∞–∫ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å—Ä–æ–∫–∏ –≥–æ–¥–Ω–æ—Å—Ç–∏",
            "–ï—Å—Ç—å –ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π",
            "–ï—Å—Ç—å –ª–∏ –≤–µ—Å–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã",
            "–ï—Å—Ç—å –ª–∏ –æ—Ç—Ä–µ–∑–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã",
            "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã"
        ],
        "–†–∞–∑–¥–µ–ª 3": [
            "–£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ª–∏ –≥–∞–±–∞—Ä–∏—Ç—ã, —à—Ç—Ä–∏—Ö–∫–æ–¥—ã",
            "–ö–∞–∫ —á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —ç—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã",
            "–ö–∞–∫–∏–µ –®–ö –±—ã–≤–∞—é—Ç",
            "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ —ç—Ç–∏–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
        ],
        "–†–∞–∑–¥–µ–ª 4": [
            "–ö–∞–∫ —Å–µ–π—á–∞—Å –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ",
            "–ö–∞–∫–∏–µ —Ç–∏–ø—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è",
            "–ö–∞–∫ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≥—Ä—É–∑–æ–≤—ã–µ –µ–¥–∏–Ω–∏—Ü—ã",
            "–ü—Ä–∏–µ–º –ø–æ –ø–∞–ª–µ—Ç–∞–º/–∫–æ—Ä–æ–±–∞–º",
            "–ö–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —É–ø–∞–∫–æ–≤–∫–∞/—Ä–∞–∑—É–ø–∞–∫–æ–≤–∫–∞"
        ],
        "–†–∞–∑–¥–µ–ª 5": [
            "–ö–∞–∫–æ–≤–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã",
            "–ö–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
        ]
    }
    
    found_sections = 0
    found_questions = 0
    total_questions = 0
    
    for section in expected_sections:
        if section in result:
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω —Ä–∞–∑–¥–µ–ª: {section}")
            found_sections += 1
        else:
            print(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Ä–∞–∑–¥–µ–ª: {section}")
    
    print("\n" + "=" * 80)
    print("–ü–†–û–í–ï–†–ö–ê –ö–õ–Æ–ß–ï–í–´–• –í–û–ü–†–û–°–û–í:")
    print("=" * 80)
    
    for section_name, questions in expected_questions.items():
        print(f"\n{section_name}:")
        for question in questions:
            total_questions += 1
            # –ò—â–µ–º –≤–æ–ø—Ä–æ—Å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
            if question.lower() in result.lower():
                print(f"  ‚úÖ {question}")
                found_questions += 1
            else:
                print(f"  ‚ùå {question}")
    
    print("\n" + "=" * 80)
    print("–ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
    print("=" * 80)
    print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ä–∞–∑–¥–µ–ª–æ–≤: {found_sections}/{len(expected_sections)}")
    print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {found_questions}/{total_questions}")
    print(f"üìä –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–∫—Ä—ã—Ç–∏—è: {found_questions/total_questions*100:.1f}%")
    
    if found_sections == len(expected_sections) and found_questions >= total_questions * 0.9:
        print("\nüéâ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù: –í—Å–µ —Ä–∞–∑–¥–µ–ª—ã –∏ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞–π–¥–µ–Ω—ã!")
    elif found_sections >= len(expected_sections) * 0.8:
        print("\n‚ö†Ô∏è –¢–ï–°–¢ –ß–ê–°–¢–ò–ß–ù–û –ü–†–û–ô–î–ï–ù: –ù–∞–π–¥–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã")
    else:
        print("\n‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù: –ù–µ –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã –Ω–∞–π–¥–µ–Ω—ã")
    
    print("\n" + "=" * 80)
    print("‚úÖ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù")
    print("=" * 80)
    
except Exception as e:
    print(f"‚ùå –û–®–ò–ë–ö–ê: {e}", file=sys.stderr)
    import traceback
    traceback.print_exc()
    sys.exit(1)

