#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –∑–∞–ø—Ä–æ—Å–∞: —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —É—á–µ—Ç–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –Ω–∞ —Å–∫–ª–∞–¥–µ
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã pageId=18153754
"""
import sys
import re

try:
    from server import collection
    import server
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    if hasattr(server.confluence_semantic_search, 'fn'):
        confluence_semantic_search = server.confluence_semantic_search.fn
    else:
        confluence_semantic_search = server.confluence_semantic_search.__wrapped__
    
    query = "—Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —É—á–µ—Ç–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –Ω–∞ —Å–∫–ª–∞–¥–µ"
    
    print("=" * 80)
    print("–¢–ï–°–¢: –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —É—á–µ—Ç–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã")
    print("=" * 80)
    print(f"\nüìù –ó–∞–ø—Ä–æ—Å: {query}")
    print(f"\nüìä –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑–µ: {collection.count()}")
    print(f"\nüéØ –û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: pageId=18153754")
    print(f"üîó URL: https://confluence.rauit.ru/pages/viewpage.action?pageId=18153754")
    print("\n" + "=" * 80)
    print("–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê:")
    print("=" * 80 + "\n")
    
    result = confluence_semantic_search(query, limit=10, space="Surveys")
    
    print(result)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    print("\n" + "=" * 80)
    print("–ü–†–û–í–ï–†–ö–ê –ù–ê–õ–ò–ß–ò–Ø –ö–õ–Æ–ß–ï–í–´–• –í–û–ü–†–û–°–û–í:")
    print("=" * 80)
    
    expected_questions = [
        "–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã",
        "–ö–∞–∫–∏–µ –≥—Ä—É–ø–ø—ã, –≤–∏–¥—ã –∏ —Ç–∏–ø—ã –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è",
        "–£—á–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤",
        "–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ —Å–µ—Ä–∏–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏",
        "–õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã",
        "–£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ª–∏ –≥–∞–±–∞—Ä–∏—Ç—ã, —à—Ç—Ä–∏—Ö–∫–æ–¥—ã",
        "–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤",
        "–ö–∞–∫–æ–≤–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã"
    ]
    
    found_count = 0
    for question in expected_questions:
        if question.lower() in result.lower():
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω: {question}")
            found_count += 1
        else:
            print(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω: {question}")
    
    print(f"\nüìä –ù–∞–π–¥–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {found_count}/{len(expected_questions)}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ pageId=18153754 –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
    if "18153754" in result:
        print("\n‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ pageId=18153754 –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö!")
    else:
        print("\n‚ö†Ô∏è –°—Ç—Ä–∞–Ω–∏—Ü–∞ pageId=18153754 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö")
    
    print("\n" + "=" * 80)
    print("‚úÖ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù")
    print("=" * 80)
    
except Exception as e:
    print(f"‚ùå –û–®–ò–ë–ö–ê: {e}", file=sys.stderr)
    import traceback
    traceback.print_exc()
    sys.exit(1)

