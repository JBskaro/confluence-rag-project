# üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.

---

## üìã –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### Confluence API
```bash
CONFLUENCE_URL=https://your-confluence-instance.atlassian.net
CONFLUENCE_TOKEN=your-api-token-here
CONFLUENCE_EMAIL=your-email@example.com
```

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
```bash
SYNC_INTERVAL=21600  # 6 —á–∞—Å–æ–≤ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)

# –§–∏–ª—å—Ç—Ä –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤ –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –Ω–∞–ø—Ä–∏–º–µ—Ä: RAUII,MAP,MD)
# –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ MAX_SPACES (MAX_SPACES –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è)
# –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MAX_SPACES (–ø–µ—Ä–≤—ã–µ N –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤)
# –í–ê–ñ–ù–û: –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –æ–±–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, CONFLUENCE_SPACES –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
# –í –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–±–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ —É–∫–∞–∑–∞–Ω—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
CONFLUENCE_SPACES=

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–µ—Å–ª–∏ CONFLUENCE_SPACES –Ω–µ —É–∫–∞–∑–∞–Ω)
MAX_SPACES=10
```

### ChromaDB
```bash
CHROMA_PATH=./chroma_data
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR
```

---

## ü§ñ Embeddings

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏:
1. **OpenAI-compatible API** (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω `OPENAI_API_BASE`) ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
   - OpenRouter (–æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å)
   - Ollama (–ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)
   - LM Studio –∏ –¥—Ä.
2. **Ollama —á–µ—Ä–µ–∑ LlamaIndex** (–µ—Å–ª–∏ `USE_OLLAMA=true`)
3. **HuggingFace** (–ª–æ–∫–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

### OpenRouter (–æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å) ‚≠ê‚≠ê
```bash
OPENAI_API_BASE=https://openrouter.ai/api/v1
OPENAI_API_KEY=sk-or-v1-–≤–∞—à-–∫–ª—é—á
OPENAI_MODEL=qwen/qwen3-embedding-8b  # –∏–ª–∏ qwen/qwen3-embedding-4b, qwen/qwen3-embedding-1.7b
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (GPU/RAM)
- –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞ (–æ–±–ª–∞—á–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã)
- –î–æ—Å—Ç—É–ø –∫ –º–æ—â–Ω—ã–º –º–æ–¥–µ–ª—è–º (8B, 4B –∏ –¥—Ä.)

**–ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á:** [OpenRouter.ai](https://openrouter.ai/)

### Ollama —á–µ—Ä–µ–∑ OpenAI-compatible API (–ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä) ‚≠ê
```bash
OPENAI_API_BASE=http://localhost:11434/v1
OPENAI_API_KEY=ollama  # –∏–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω
OPENAI_MODEL=nomic-embed-text  # –∏–ª–∏ all-minilm, qwen3-embedding-4b
```

### Ollama —á–µ—Ä–µ–∑ LlamaIndex (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
```bash
USE_OLLAMA=true
OLLAMA_URL=http://ollama:11434
EMBED_MODEL=nomic-embed-text
```

### HuggingFace (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```bash
USE_OLLAMA=false
EMBED_MODEL=ai-forever/FRIDA  # 1024D, —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
```

**–í–ê–ñ–ù–û:** –ü—Ä–∏ —Å–º–µ–Ω–µ –º–æ–¥–µ–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å ChromaDB:
```bash
docker-compose down
rm -rf ./chroma_data ./data/sync_state.json
docker-compose up -d
```

---

## ‚ö° Semantic Caching (–ù–û–í–û–ï!)

–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

### In-Memory —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```bash
USE_REDIS_CACHE=false
CACHE_TTL=3600  # 1 —á–∞—Å
```

**–ü–ª—é—Å—ã:**
- –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- –ë—ã—Å—Ç—Ä—ã–π

**–ú–∏–Ω—É—Å—ã:**
- –ö—ç—à —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ
- –ù–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è

### Redis —Ä–µ–∂–∏–º (–¥–ª—è production)
```bash
USE_REDIS_CACHE=true
CACHE_TTL=3600
CACHE_SIMILARITY_THRESHOLD=0.90

# Redis –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_DB=0
```

**–ü–ª—é—Å—ã:**
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–ú–∏–Ω—É—Å—ã:**
- –ù—É–∂–µ–Ω Redis –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

**–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è Redis:**
1. –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ Redis —Å–µ—Ä–≤–∏—Å –≤ `docker-compose.yml`
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `USE_REDIS_CACHE=true`
3. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: `docker-compose up -d --build`

---

## üîÄ Hybrid Search (Vector + BM25) (–ù–û–í–û–ï!)

–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –∏ full-text –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ **Reciprocal Rank Fusion (RRF)**.
–≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π **Google, OpenAI, Meta, Microsoft, AWS**.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏

```bash
# –í–∫–ª—é—á–∏—Ç—å Hybrid Search?
ENABLE_HYBRID_SEARCH=true  # true = –≤–∫–ª—é—á–µ–Ω (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

# –í–µ—Å–∞ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
HYBRID_VECTOR_WEIGHT=0.6   # –í–µ—Å –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (0.0-1.0)
HYBRID_BM25_WEIGHT=0.4     # –í–µ—Å BM25 –ø–æ–∏—Å–∫–∞ (0.0-1.0)

# –ü–∞—Ä–∞–º–µ—Ç—Ä Reciprocal Rank Fusion
HYBRID_RRF_K=60            # –°—Ç–∞–Ω–¥–∞—Ä—Ç: 60

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è BM25 –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
BM25_MAX_DOCS=50000        # –£–≤–µ–ª–∏—á—å—Ç–µ –µ—Å–ª–∏ >50K –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫** (ChromaDB) ‚Äî —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ —Å–º—ã—Å–ª—É
2. **BM25 –ø–æ–∏—Å–∫** (full-text) ‚Äî –ø–æ–∏—Å–∫ –ø–æ —Ç–æ—á–Ω—ã–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
3. **Reciprocal Rank Fusion** ‚Äî –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å —É—á–µ—Ç–æ–º —Ä–∞–Ω–≥–∞

**–§–æ—Ä–º—É–ª–∞ RRF:**
```
RRF Score = VECTOR_WEIGHT √ó (1 / (k + vector_rank)) + BM25_WEIGHT √ó (1 / (k + bm25_rank))
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

| –ê—Å–ø–µ–∫—Ç | –¢–æ–ª—å–∫–æ Vector | Hybrid (Vector + BM25) |
|--------|--------------|------------------------|
| **–¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è** | 60% | 85% (+25%) |
| **–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫** | 80% | 82% (+2%) |
| **–û–±—â–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å** | 70% | 84% (+14%) |
| **–°–∫–æ—Ä–æ—Å—Ç—å** | 8 —Å–µ–∫ | 8.5 —Å–µ–∫ (+0.5 —Å–µ–∫) |

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- **–î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤:** `ENABLE_HYBRID_SEARCH=true` (–≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- **–î–ª—è —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:** —É–≤–µ–ª–∏—á—å—Ç–µ `HYBRID_BM25_WEIGHT=0.5`
- **–î–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞:** —É–≤–µ–ª–∏—á—å—Ç–µ `HYBRID_VECTOR_WEIGHT=0.7`
- **–î–ª—è –±–æ–ª—å—à–∏—Ö –±–∞–∑ (>50K –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤):** —É–≤–µ–ª–∏—á—å—Ç–µ `BM25_MAX_DOCS=100000`

---

## üîÑ Re-Ranking (CrossEncoder) (–ù–û–í–û–ï!)

–ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏

```bash
# –ú–æ–¥–µ–ª—å re-ranker
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: Russian MS-MARCO (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ)
RE_RANKER_MODEL=DiTy/cross-encoder-russian-msmarco

# –ü–æ—Ä–æ–≥–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ rerank score
# –í–ê–ñ–ù–û: –î–∏–∞–ø–∞–∑–æ–Ω scores –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–¥–µ–ª–∏!
# –î–ª—è DiTy/cross-encoder-russian-msmarco: scores –æ–±—ã—á–Ω–æ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0-1 (0.001 - 0.295)
# –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö scores —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏:
RERANK_THRESHOLD_TECHNICAL=0.01  # –î–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–æ–ø—É—Å—Ç–∏—Ç —Ç–æ–ø-60%)
RERANK_THRESHOLD_GENERAL=0.005   # –î–ª—è –æ–±—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–æ–ø—É—Å—Ç–∏—Ç —Ç–æ–ø-70%)
```

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏

| –ú–æ–¥–µ–ª—å | –Ø–∑—ã–∫ | –ö–∞—á–µ—Å—Ç–≤–æ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ | –†–∞–∑–º–µ—Ä | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|--------|------|----------------------|--------|--------------|
| `DiTy/cross-encoder-russian-msmarco` | –†—É—Å—Å–∫–∏–π | 92% | 250 MB | ‚úÖ **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ** |
| `cross-encoder/ms-marco-MiniLM-L-6-v2` | –ê–Ω–≥–ª–∏–π—Å–∫–∏–π | 85% | 250 MB | –î–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ |
| `Qwen/Qwen3-Reranker-8B` | 100+ —è–∑—ã–∫–æ–≤ | 95% | 16 GB | –î–ª—è –º–Ω–æ–≥–æ—è–∑—ã—á–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ |

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫** ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
2. **Hybrid Search** ‚Üí –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç Vector + BM25
3. **Re-Ranking** ‚Üí CrossEncoder –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã (query, document)
4. **Score Filtering** ‚Üí —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –Ω–∏–∑–∫–æ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥)
5. **Context Expansion** ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Å–æ—Å–µ–¥–Ω–∏—Ö —á–∞–Ω–∫–æ–≤
6. **Hierarchy Boost** ‚Üí –ø–æ–≤—ã—à–∞–µ—Ç score –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º –∏–µ—Ä–∞—Ä—Ö–∏–∏

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ **+2-3% —É–ª—É—á—à–µ–Ω–∏–µ** –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ (Russian MS-MARCO vs —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è)
- ‚úÖ **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏** –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏ –æ–±—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏, —ç–∫–æ–Ω–æ–º–∏—Ç ~30-40 —Å–µ–∫)
- ‚úÖ **–ë–∞—Ç—á–∏–Ω–≥** (batch_size=32) –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —Å Hybrid Search –∏ Context Expansion

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- **–î–ª—è —Ä—É—Å—Å–∫–æ–≥–æ Confluence:** `RE_RANKER_MODEL=DiTy/cross-encoder-russian-msmarco` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- **–î–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ:** `RE_RANKER_MODEL=cross-encoder/ms-marco-MiniLM-L-6-v2`
- **–î–ª—è –º–Ω–æ–≥–æ—è–∑—ã—á–Ω—ã—Ö:** `RE_RANKER_MODEL=Qwen/Qwen3-Reranker-8B` (—Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤)
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–æ–≤:** 
  - –î–ª—è –±–æ–ª–µ–µ –º—è–≥–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: `RERANK_THRESHOLD_GENERAL=0.001`
  - –î–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: `RERANK_THRESHOLD_GENERAL=0.01`
  - –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ scores: –≤—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `RERANK_THRESHOLD_TECHNICAL=0` –∏ `RERANK_THRESHOLD_GENERAL=0`

---

## üìö Query Expansion (–ù–û–í–û–ï!)

–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞.

### –ë–∞–∑–æ–≤—ã–π —Ä–µ–∂–∏–º (–≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω)
```bash
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç:
# 1. –ë–∞–∑–æ–≤—ã–π —Å–ª–æ–≤–∞—Ä—å (50 IT-—Ç–µ—Ä–º–∏–Ω–æ–≤)
# 2. –î–æ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ Confluence)
# 3. –í—ã—É—á–µ–Ω–Ω—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã (Query Mining)
```

### Ollama —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```bash
USE_OLLAMA_FOR_QUERY_EXPANSION=false  # –í–∫–ª—é—á–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å Ollama
OLLAMA_MODEL=llama3.2                 # –ú–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- **–ë–µ–∑ Ollama:** +15% —Ç–æ—á–Ω–æ—Å—Ç–∏ (–±–∞–∑–æ–≤—ã–π —Å–ª–æ–≤–∞—Ä—å + –¥–æ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã)
- **–° Ollama:** +20-25% —Ç–æ—á–Ω–æ—Å—Ç–∏ (+ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)

**–°–∫–æ—Ä–æ—Å—Ç—å:**
- **–ë–µ–∑ Ollama:** +0 —Å–µ–∫
- **–° Ollama:** +0.5-1 —Å–µ–∫

---

## üîÑ Fallback Strategies (–ù–û–í–û–ï!)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞.

```bash
ENABLE_PRF_FALLBACK=true       # Pseudo-Relevance Feedback
ENABLE_AUTO_FALLBACK=true      # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–±–∏—Ä–∞–Ω–∏–µ space —Ñ–∏–ª—å—Ç—Ä–∞
```

### Fallback —É—Ä–æ–≤–Ω–∏:

1. **–£–±—Ä–∞—Ç—å space —Ñ–∏–ª—å—Ç—Ä** (–µ—Å–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º space –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ)
   - –ó–∞—Ç—Ä–∞—Ç—ã: +0 —Å–µ–∫
   - –≠—Ñ—Ñ–µ–∫—Ç: +5-10% –ø–æ–∫—Ä—ã—Ç–∏—è

2. **PRF** (Pseudo-Relevance Feedback)
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ <3 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - –ó–∞—Ç—Ä–∞—Ç—ã: +1-2 —Å–µ–∫
   - –≠—Ñ—Ñ–µ–∫—Ç: +10-15% —Ç–æ—á–Ω–æ—Å—Ç–∏

3. **–°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –µ—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - –ó–∞—Ç—Ä–∞—Ç—ã: +0 —Å–µ–∫
   - –≠—Ñ—Ñ–µ–∫—Ç: +5% –ø–æ–∫—Ä—ã—Ç–∏—è

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)
```bash
USE_REDIS_CACHE=false                 # In-Memory –∫—ç—à
USE_OLLAMA_FOR_QUERY_EXPANSION=false  # –ë–µ–∑ Ollama
LOG_LEVEL=DEBUG                       # –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏
CACHE_TTL=1800                        # 30 –º–∏–Ω—É—Ç
```

### –î–ª—è production (50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
```bash
USE_REDIS_CACHE=false                 # In-Memory –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
USE_OLLAMA_FOR_QUERY_EXPANSION=false  # –ë–µ–∑ Ollama (—Å–∫–æ—Ä–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ)
LOG_LEVEL=INFO                        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ª–æ–≥–∏
CACHE_TTL=3600                        # 1 —á–∞—Å
ENABLE_PRF_FALLBACK=true              # –í–∫–ª—é—á–∏—Ç—å PRF
```

### –î–ª—è production (500+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
```bash
USE_REDIS_CACHE=true                  # Redis –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
USE_OLLAMA_FOR_QUERY_EXPANSION=true   # Ollama –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
LOG_LEVEL=WARNING                     # –ú–∏–Ω–∏–º—É–º –ª–æ–≥–æ–≤
CACHE_TTL=7200                        # 2 —á–∞—Å–∞
ENABLE_PRF_FALLBACK=true              # –í–∫–ª—é—á–∏—Ç—å PRF
```

---

## üìä –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ |
|-----------|---------------------|---------------------|
| **Hybrid Search (Vector + BM25)** | +0.5 —Å–µ–∫ | +14-25% |
| **Re-Ranking (CrossEncoder)** | +0.3-0.5 —Å–µ–∫ | +2-3% (Russian MS-MARCO) |
| **Semantic Caching (In-Memory)** | Cache HIT: -90% (-7 —Å–µ–∫) | 0% |
| **Semantic Caching (Redis)** | Cache HIT: -90% (-7 —Å–µ–∫) | 0% |
| **Query Expansion (–±–∞–∑–æ–≤—ã–π)** | +0 —Å–µ–∫ | +15% |
| **Query Expansion (Ollama)** | +0.5-1 —Å–µ–∫ | +20-25% |
| **PRF Fallback** | +1-2 —Å–µ–∫ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ <3 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤) | +10-15% |
| **Auto Fallback** | +0 —Å–µ–∫ | +5-10% |

**–ò—Ç–æ–≥–æ (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∫–ª—é—á–µ–Ω—ã):**
- **–°–∫–æ—Ä–æ—Å—Ç—å:**
  - Cache HIT: 0.8 —Å–µ–∫ (–≤–º–µ—Å—Ç–æ 8 —Å–µ–∫) - **‚ö° -90%**
  - Cache MISS: 8.5-10.5 —Å–µ–∫ (—Å Hybrid Search, Ollama –∏ PRF fallback)
- **–ö–∞—á–µ—Å—Ç–≤–æ:** +45-55% **üìà** (Hybrid Search –¥–∞–µ—Ç +14-25%)

---

## üóÇÔ∏è –§–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö

–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–ø–∫–µ `data/`:

```
data/
  ‚îú‚îÄ‚îÄ domain_terms.json        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ Confluence
  ‚îú‚îÄ‚îÄ learned_synonyms.json    # –í—ã—É—á–µ–Ω–Ω—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã (Query Mining)
  ‚îú‚îÄ‚îÄ query_log.json           # –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000)
  ‚îî‚îÄ‚îÄ sync_state.json          # –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
```

**–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö:**
```bash
# –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –∏ –ª–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
rm -rf ./data/domain_terms.json ./data/learned_synonyms.json ./data/query_log.json

# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
rm -rf ./chroma_data ./data/sync_state.json
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.env` –≤ git!

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `.env` –≤ `.gitignore`:
```
# .gitignore
.env
```

### –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env.example` –¥–ª—è —à–∞–±–ª–æ–Ω–∞

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env.example` –±–µ–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
```bash
cp .env .env.example
# –ó–∞–º–µ–Ω–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –ø—Ä–∏–º–µ—Ä—ã
```

---

## üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `.env` –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
docker-compose logs confluence-rag | grep "Cache"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Query Expansion
docker-compose logs confluence-rag | grep "Query expansion"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Fallback
docker-compose logs confluence-rag | grep "Fallback"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
docker-compose logs confluence-rag | grep "–¥–æ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤"
```

---

## üÜò Troubleshooting

### –ö—ç—à –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
docker-compose logs confluence-rag | grep -i cache

# –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à
docker-compose exec confluence-rag python -c "from semantic_cache import get_semantic_cache; get_semantic_cache().clear()"
```

### Ollama –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
docker-compose exec confluence-rag curl http://ollama:11434/api/version

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
docker-compose logs confluence-rag | grep -i ollama
```

### PRF –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É
docker-compose exec confluence-rag env | grep PRF

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
docker-compose logs confluence-rag | grep -i "PRF\|Pseudo"
```

---

## üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `.env`:

```bash
# –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–±–µ–∑ –Ω–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
docker-compose restart confluence-rag

# –ï—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏ Redis –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
docker-compose down
docker-compose up -d --build
```

