# üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –õ–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –¥–ª—è BM25 (Hybrid Search)

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

1. **–î–æ–±–∞–≤–ª–µ–Ω pymorphy2** –≤ `requirements.txt`
   - `pymorphy2>=0.9.1`
   - `pymorphy2-dicts-ru>=2.4.0`

2. **–°–æ–∑–¥–∞–Ω `rag_server/utils/lemmatizer.py`**
   - –õ–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
   - LRU –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (10000√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ)
   - Graceful degradation (—Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó pymorphy2 –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

3. **–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω `rag_server/hybrid_search.py`**
   - –õ–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è documents –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ BM25 –∏–Ω–¥–µ–∫—Å–∞
   - –õ–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è query –ø—Ä–∏ BM25 –ø–æ–∏—Å–∫–µ
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏

---

## üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É

### **–í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

#### Windows (PowerShell):
```powershell
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Docker Desktop
# 2. –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç
.\rebuild_with_lemmatization.ps1
```

#### Linux/Mac (Bash):
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Docker
# 2. –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç
chmod +x rebuild_with_lemmatization.sh
./rebuild_with_lemmatization.sh
```

---

### **–í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞**

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose stop confluence-rag

# 2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑ (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ pymorphy2)
docker-compose build confluence-rag

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose up -d confluence-rag

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏)
docker-compose logs confluence-rag --tail=50 | grep -i "–ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è\|pymorphy"
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

### **1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ pymorphy2 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω**

```bash
docker-compose exec confluence-rag pip show pymorphy2
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
Name: pymorphy2
Version: 0.9.1
...
```

### **2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ**

```bash
docker-compose logs confluence-rag | grep -i "–ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è\|lemma"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
‚úÖ –õ–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è (pymorphy2) –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è Hybrid Search
üî§ –ü—Ä–∏–º–µ–Ω—è—é –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—é –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –¥–ª—è BM25...
‚úÖ BM25 retriever –≥–æ—Ç–æ–≤ (–° –õ–ï–ú–ú–ê–¢–ò–ó–ê–¶–ò–ï–ô ‚úÖ). –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ 628 nodes
```

### **3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**

```bash
docker-compose exec confluence-rag python -c "
import sys; sys.path.insert(0, '/app')
from rag_server.utils.lemmatizer import lemmatize_text
print(lemmatize_text('—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ –ø—Ä–æ–µ–∫—Ç–∞'))
print(lemmatize_text('–°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è'))
"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ –ø—Ä–æ–µ–∫—Ç
—Å—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
```

---

## üéØ –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π –ø–æ–∏—Å–∫:

```bash
# –ß–µ—Ä–µ–∑ Cursor MCP –∏–ª–∏ curl
curl -X POST http://localhost:5050/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "method": "tools/call",
    "params": {
      "name": "confluence_semantic_search",
      "arguments": {
        "query": "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ –ø—Ä–æ–µ–∫—Ç–∞ RAUII",
        "limit": 10,
        "space": "RAUII"
      }
    }
  }' | jq '.results[] | select(.page_id == "18153591")'
```

### **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

–°—Ç—Ä–∞–Ω–∏—Ü–∞ **18153591** ("–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ", heading "–°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π") –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ **—Ç–æ–ø-10** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

**–î–æ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏:**
- –ü–æ–∑–∏—Ü–∏—è: #150+ (–ù–ï –ù–ê–ô–î–ï–ù–ê –≤ —Ç–æ–ø-100)
- –ü—Ä–∏—á–∏–Ω–∞: "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π" ‚â† "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π" (—Ä–∞–∑–Ω—ã–µ —Å–ª–æ–≤–æ—Ñ–æ—Ä–º—ã)

**–ü–æ—Å–ª–µ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏:**
- –ü–æ–∑–∏—Ü–∏—è: **#3-7** (–Ω–∞–π–¥–µ–Ω–∞! ‚úÖ)
- –ü—Ä–∏—á–∏–Ω–∞: BM25 + lemmatization ‚Üí "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π" ‚âà "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è" ‚Üí MATCH!

---

## üìä –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

| –ü–æ–∑–∏—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã 18153591 | –û—Ü–µ–Ω–∫–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|---------------------------|--------|----------|
| **–¢–æ–ø-3** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚úÖ **–û–¢–õ–ò–ß–ù–û!** Heading boost –ù–ï –Ω—É–∂–µ–Ω |
| **–ü–æ–∑–∏—Ü–∏—è #4-7** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚úÖ –•–æ—Ä–æ—à–æ, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å heading boost 2√ó |
| **–ü–æ–∑–∏—Ü–∏—è #8-10** | ‚≠ê‚≠ê‚≠ê | ‚ö†Ô∏è –î–æ–±–∞–≤—å heading boost 2-3√ó |
| **–ù–ï –≤ —Ç–æ–ø-10** | ‚≠ê‚≠ê | ‚ùå –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç |

---

## üêõ Troubleshooting

### **–ü—Ä–æ–±–ª–µ–º–∞: pymorphy2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω**

```bash
# –†–µ—à–µ–Ω–∏–µ: –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
docker-compose exec confluence-rag pip install pymorphy2 pymorphy2-dicts-ru

# –ó–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose restart confluence-rag
```

### **–ü—Ä–æ–±–ª–µ–º–∞: "–ë–ï–ó –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏ ‚ö†Ô∏è" –≤ –ª–æ–≥–∞—Ö**

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ pymorphy2 –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è. –ü—Ä–æ–≤–µ—Ä—å:

1. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ pymorphy2 –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ?
   ```bash
   docker-compose exec confluence-rag pip show pymorphy2
   ```

2. –ï—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞?
   ```bash
   docker-compose logs confluence-rag | grep -i "ImportError\|ModuleNotFoundError"
   ```

### **–ü—Ä–æ–±–ª–µ–º–∞: –°—Ç—Ä–∞–Ω–∏—Ü–∞ 18153591 –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è**

1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ BM25 retriever –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:
   ```bash
   docker-compose logs confluence-rag | grep "BM25 retriever –≥–æ—Ç–æ–≤"
   ```

2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è query —Ä–∞–±–æ—Ç–∞–µ—Ç:
   ```bash
   docker-compose logs confluence-rag | grep "Query:.*‚Üí Lemmatized:"
   ```

3. –ï—Å–ª–∏ –∏ —ç—Ç–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, –¥–æ–±–∞–≤—å **heading boost** (—Å–º. —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª)

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: Heading Boost (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 18153591 –≤—Å—ë –µ—â—ë –Ω–µ –≤ —Ç–æ–ø-7, –¥–æ–±–∞–≤—å **heading boost**:

1. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π `rag_server/sync_confluence.py`
2. –ü–æ–≤—Ç–æ—Ä—è–π heading 2-3√ó –≤ —Ç–µ–∫—Å—Ç–µ chunk
3. –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–π: `docker-compose exec confluence-rag python sync_confluence.py --space RAUII --force`

**–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** —Å–º. –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ.

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### **–ß—Ç–æ —Ç–∞–∫–æ–µ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è?**

–õ–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è ‚Äî —ç—Ç–æ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Å–ª–æ–≤–∞ –∫ –µ–≥–æ –Ω–∞—á–∞–ª—å–Ω–æ–π (—Å–ª–æ–≤–∞—Ä–Ω–æ–π) —Ñ–æ—Ä–º–µ.

**–ü—Ä–∏–º–µ—Ä—ã:**
- "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π" ‚Üí "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è"
- "–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è" ‚Üí "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è"
- "–ø—Ä–æ–µ–∫—Ç–æ–≤" ‚Üí "–ø—Ä–æ–µ–∫—Ç"

### **–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è BM25?**

BM25 –∏—â–µ—Ç **—Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤**. –ë–µ–∑ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏:
- Query: "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫"
- Document: "–°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π"
- Match: —Ç–æ–ª—å–∫–æ "—Å—Ç–µ–∫" (50%)

–° –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π:
- Query: "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫" ‚Üí "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫"
- Document: "–°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π" ‚Üí "—Å—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è"
- Match: "—Å—Ç–µ–∫" + "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è" ‚âà "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π" (90%+)

### **–¢–æ–ø–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—é:**

- **Elastic Search:** —Ä—É—Å—Å–∫–∏–π analyzer —Å stemming
- **Pinecone:** —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç lemmatization –¥–ª—è non-English
- **Weaviate:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è lemmatization
- **Qdrant:** hybrid search —Å preprocessing

---

**–£—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏! üöÄ**

