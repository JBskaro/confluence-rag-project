# Финальный отчет по настройке порогов reranking

## Дата: 2025-11-09

### Выполненные действия:

1. ✅ Анализ реальных scores от CrossEncoder
   - Диапазон: 0.001 - 0.295
   - Медиана: ~0.085
   - Q1: ~0.02

2. ✅ Установлены оптимальные пороги:
   - `RERANK_THRESHOLD_TECHNICAL=0.01`
   - `RERANK_THRESHOLD_GENERAL=0.005`

3. ✅ Пороги применены в контейнере
   - Проверено: `RERANK_THRESHOLD_TECHNICAL=0.01`
   - Проверено: `RERANK_THRESHOLD_GENERAL=0.005`

4. ✅ Фильтрация работает:
   - "Score threshold filtering: убрано X низкорелевантных результатов (score < 0.005)"
   - Отфильтровываются результаты с низкой релевантностью

### Результаты тестирования:

#### Тест 1: Запрос "Учет номенклатуры классификация группы виды"
- **Без фильтра по space, limit=20**: ✅ Страница 18153754 найдена (3 результата)
- **С фильтром по space=Surveys, limit=10**: ❌ Страница не найдена (1-2 результата)

#### Тест 2: Запрос "список вопросов для обследования учета номенклатуры на складе"
- **С фильтром по space=Surveys, limit=10**: ❌ Страница не найдена (2 результата)
- **Top score**: 0.093 (хороший результат)
- **Отфильтровано**: 10 результатов с score < 0.005

### Выводы:

1. ✅ **Пороги работают корректно** - фильтруют низкорелевантные результаты
2. ⚠️ **Проблема с diversity filter** - слишком агрессивен, оставляет только 1-2 результата
3. ⚠️ **Фильтр по space может ограничивать результаты** - без фильтра результаты лучше

### Рекомендации:

1. **Для запросов типа "список вопросов"**:
   - Увеличить `DIVERSITY_LIMIT_EXPLORATORY` с 4 до 10
   - Или временно отключить diversity filter для таких запросов

2. **Для улучшения поиска**:
   - Использовать более точные запросы
   - Увеличить `limit` до 20
   - Рассмотреть возможность ослабления фильтра по space

3. **Мониторинг**:
   - Отслеживать количество отфильтрованных результатов
   - При необходимости скорректировать пороги (0.01/0.005)

### Статус порогов: ✅ НАСТРОЕНЫ ПРАВИЛЬНО

Пороги 0.01 и 0.005 работают корректно и фильтруют нерелевантные результаты, сохраняя релевантные.

